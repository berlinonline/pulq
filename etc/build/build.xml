<?xml version="1.0" encoding="utf-8"?>
<project name="Pulq" basedir="." default="cc">
    <!-- 
        project property definitions
    -->
    <property name="project.directory" value="${application.startdir}" />
    <property name="project.codegen.target" value="${application.startdir}/../project/modules" />
    <property name="project.directory.etc" value="${application.startdir}/etc" />
    <property userProperty="true" override="true" file="${project.directory.etc}/build/build.properties" />
    <property name="module.directory.impl" value="impl" />
    <property name="module.directory.resources" value="resources" />

	<taskdef name="run" classname="PulqRunTask" classpath="${project.directory.etc}/build/tasks"/>

    <!-- 
        Custom module wizward target that builds full stack pulq modules along with 
        framework boilerplate and default implementations.
    -->
    <target name="pulq-module-wizard" depends="project-locate" description="Creates a pulq module.">
        <!--# Setup/Prompt Properties #-->
        <agavi.input property="module.name" message="Module name" promptCharacter=":" failIfEmpty="true" ignoreIfSet="true" />
        <property userProperty="true" name="module.name.input" value="${module.name}" override="true" />
        <agavi.transform-string-to-identifier property="module.name" string="${module.name}" />
        <if>
            <not>
                <equals arg1="${module.name}" arg2="${module.name.input}" />
            </not>
            <then>
                <echo message="Module name ${module.name.input} is not a valid identifier; ${module.name} will be used instead" level="warning" />
            </then>
        </if>
        <!-- @todo need a real impl for building module prefixes -->
        <php expression="strtolower('${module.name}')" returnProperty="module.prefix"/>
        <property userProperty="true" name="module.directory" value="${project.codegen.target}/${module.name}" override="true" />
        <agavi.check-module property="module.available" path="${module.directory}" />
        <fail if="module.available" message="Module ${module.name} already exists at ${module.directory}" />
        <property userProperty="true" name="module.ln_target" value="${project.directory}/app/modules/${module.name}" override="true" />
        <!--# Create Directories #-->
        <mkdir dir="${module.directory}" />
        <mkdir dir="${module.directory}/${module.directory.impl}" />
        <mkdir dir="${module.directory}/${module.directory.config}" />
        <mkdir dir="${module.directory}/${module.directory.lib}" />
        <mkdir dir="${module.directory}/${module.directory.resources}" />

        <!--# Create Library #-->
        <agavi.select-path property="template.path" type="directory" path="${templates.directory.app.modules.lib}">
            <from path="${templates.module.directory}" />
        </agavi.select-path>
        <copy todir="${module.directory}/${module.directory.lib}">
            <mapper type="regexp" from="^(.+[\\\/])?(.+)\.tmpl$" to="\1/${module.name}\2" />
            <fileset dir="${template.path}">
                <include name="**/*.tmpl" />
                <exclude name="**/workflow/plugin/*.tmpl" />
            </fileset>
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="MODULE_PREFIX" value="${module.prefix}" />
                    <token key="PROJECT_LOCATION" value="${project.directory}" />
                    <token key="PROJECT_PREFIX" value="${project.prefix}" />
                    <token key="MODULE_NAME" value="${module.name}" />
                </replacetokens>
            </filterchain>
        </copy>

        <!--# Copy Configuration #-->
        <agavi.select-path property="template.path" path="${templates.directory.app.modules.config}">
            <from path="${templates.module.directory}" />
        </agavi.select-path>
        <!-- Start with xml files ... -->
        <copy todir="${module.directory}/${module.directory.config}">
            <mapper type="glob" from="*.xml.tmpl" to="*.xml" />
            <fileset dir="${template.path}">
                <include name="**/*.xml.tmpl" />
            </fileset>
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="DB_PREFIX" value="${project.db_prefix}" />
                    <token key="MODULE_PREFIX" value="${module.prefix}" />
                    <token key="PROJECT_LOCATION" value="${project.directory}" />
                    <token key="PROJECT_PREFIX" value="${project.prefix}" />
                    <token key="MODULE_NAME" value="${module.name}" />
                </replacetokens>
            </filterchain>
        </copy>
        <copy todir="${module.directory}/${module.directory.config}">
            <mapper type="regexp" from="^(.+[\\\/])?(.+)\.tmpl$" to="\1/${module.prefix}\2" />
            <fileset dir="${template.path}">
                <include name="**/*.js.tmpl" />
                <include name="**/*.json.tmpl" />
            </fileset>
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="DB_PREFIX" value="${project.db_prefix}" />
                    <token key="MODULE_PREFIX" value="${module.prefix}" />
                    <token key="PROJECT_LOCATION" value="${project.directory}" />
                    <token key="PROJECT_PREFIX" value="${project.prefix}" />
                    <token key="MODULE_NAME" value="${module.name}" />
                </replacetokens>
            </filterchain>
        </copy>

        <!--# Copy Script Resources #-->
        <agavi.select-path property="template.path" type="directory" path="${templates.directory.app.modules}/resources">
            <from path="${templates.module.directory}" />
        </agavi.select-path>
        <copy todir="${module.directory}/${module.directory.resources}">
            <mapper type="regexp" from="^(.+[\\\/])?(.+)\.tmpl$" to="\1/${module.prefix}\2" />
            <fileset dir="${template.path}">
                <include name="**/*.js.tmpl" />
            </fileset>
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="MODULE_PREFIX" value="${module.prefix}" />
                    <token key="PROJECT_LOCATION" value="${project.directory}" />
                    <token key="PROJECT_PREFIX" value="${project.prefix}" />
                    <token key="MODULE_NAME" value="${module.name}" />
                </replacetokens>
            </filterchain>
        </copy>
        <copy toDir="${module.directory}/${module.directory.resources}/scripts/" 
              file="${template.path}/scripts/.index">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="MODULE_PREFIX" value="${module.prefix}" />
                    <token key="PROJECT_LOCATION" value="${project.directory}" />
                    <token key="PROJECT_PREFIX" value="${project.prefix}" />
                    <token key="MODULE_NAME" value="${module.name}" />
                </replacetokens>
            </filterchain>
        </copy>

        <!--# Create default actions (Index) #-->
        <agavi.select-path property="template.path" type="directory" path="${templates.directory.app.modules}/impl">
            <from path="${templates.module.directory}" />
        </agavi.select-path>
        <copy todir="${module.directory}/${module.directory.impl}">
            <mapper type="regexp" from="^(.+[\\\/])?(.+)\.tmpl$" to="\1\2" />
            <fileset dir="${template.path}">
                <include name="**/*.tmpl" />
            </fileset>
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="MODULE_PREFIX" value="${module.prefix}" />
                    <token key="PROJECT_LOCATION" value="${project.directory}" />
                    <token key="PROJECT_PREFIX" value="${project.prefix}" />
                    <token key="MODULE_NAME" value="${module.name}" />
                </replacetokens>
            </filterchain>
        </copy>

        <run command="make link-project-modules" dir="${project.directory}" />
		<property userProperty="true" name="action.name" value="Index" override="true" />
		<agavi.execute-target name="pulq-action-wizard" />
    </target>

    <!-- 
        Custom module wizward target that builds full stack pulq modules along with 
        framework boilerplate and default implementations.
    -->
    <target name="pulq-action-wizard" depends="project-locate" description="Creates a pulq action.">
        <!--# Setup/Prompt Properties #-->
        <agavi.input property="module.name" message="Module name" promptCharacter=":" failIfEmpty="true" ignoreIfSet="true" />
        <property userProperty="true" name="module.name.input" value="${module.name}" override="true" />
        <agavi.transform-string-to-identifier property="module.name" string="${module.name}" />
        <if>
            <not>
                <equals arg1="${module.name}" arg2="${module.name.input}" />
            </not>
            <then>
                <echo message="Module name ${module.name.input} is not a valid identifier; ${module.name} will be used instead" level="warning" />
            </then>
        </if>

        <agavi.input property="action.name" message="Action name" promptCharacter=":" failIfEmpty="true" ignoreIfSet="true" />
        <property userProperty="true" name="action.name.input" value="${action.name}" override="true" />
        <agavi.transform-string-to-identifier property="action.name" string="${action.name}" />
        <if>
            <not>
                <equals arg1="${action.name}" arg2="${action.name.input}" />
            </not>
            <then>
                <echo message="Action name ${action.name.input} is not a valid identifier; ${action.name} will be used instead" level="warning" />
            </then>
        </if>

		<property userProperty="true" name="module.directory" value="${project.directory}/${project.directory.app.modules}/${module.name}" override="true" />
		<agavi.check-module property="module.available" path="${module.directory}" />
		<fail unless="module.available" message="Module ${module.name} dows not exist at ${module.directory}" />

        <!--# Create default actions (Index) #-->
        <agavi.select-path property="template.path" type="directory" path="${templates.directory.app.modules}/impl">
            <from path="${templates.action.directory}" />
        </agavi.select-path>
        <copy todir="${module.directory}/${module.directory.impl}/${action.name}">
            <mapper type="regexp" from="^ActionName(.+)\.tmpl$" to="${action.name}\1" />
            <fileset dir="${template.path}">
                <include name="**/*.tmpl" />
            </fileset>
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="MODULE_PREFIX" value="${module.prefix}" />
                    <token key="PROJECT_LOCATION" value="${project.directory}" />
                    <token key="PROJECT_PREFIX" value="${project.prefix}" />
                    <token key="MODULE_NAME" value="${module.name}" />
                    <token key="ACTION_NAME" value="${action.name}" />
                </replacetokens>
            </filterchain>
        </copy>
    </target>
</project>
