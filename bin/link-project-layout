#!/bin/bash

### Functons definition ###

function deleted() {
    FILE_PATH=$1
    if [ -L $FILE_PATH ]
      then
        if [ ! "$REPLACE_ALL" == "true" ]
          then
            read -p "The symlink 'pub/$ITEM' already exists. Do you want to overwrite it? (Yes/No/All): " -r -n 1
            echo -e "\r"
            case "$REPLY" in
              a|A|all|All|ALL    )
                REPLACE_ALL="true";;
              n|N|no|No|NO      )
                return 2;;
            esac
        fi
        rm "$FILE_PATH"
    fi
    return 0
}
### Script ###

## Get directories info
BASEDIR=`readlink -f "$( dirname $0 )/.."` # Pulq directory
PWD=`pwd`
REPLACE_ALL="false"

## Check parameter
VERSION=$1
if [ -z "$1" ]
  then
    echo -e "\nPlease provide a version name\r"
    exit 2
fi

LAYOUTS_DIR="$BASEDIR/../project/app/layouts"
VERSION_DIR="$LAYOUTS_DIR/v$VERSION"
if [ ! -d "$VERSION_DIR" ]
  then
    echo -e "\nThe specified version doesn't exist\r"
    exit 2
fi

## Check if symlinks exist and overwrite them

# Pub directory
cd $BASEDIR
APP_PUB_DIR="$BASEDIR/pub"
PROJECT_I9F_RESOURCES_DIR="$VERSION_DIR/resources"
for ITEM in `ls $PROJECT_I9F_RESOURCES_DIR`; do
    if deleted "$APP_PUB_DIR/$ITEM";
      then
        echo "Linking $PROJECT_I9F_RESOURCES_DIR/$ITEM -> pub/$ITEM"
        ln -s "$PROJECT_I9F_RESOURCES_DIR/$ITEM" "$APP_PUB_DIR/$ITEM"
    fi
done

# Includes directory
APP_INCLUDES_DIR="$BASEDIR/../project/app/templates/macros/includes"
PROJECT_I9F_INCLUDES_DIR="$VERSION_DIR/includes"
for ITEM in `ls $PROJECT_I9F_INCLUDES_DIR`; do
    if deleted "$APP_INCLUDES_DIR/$ITEM";
    then
        echo "Linking $PROJECT_I9F_RESOURCES_DIR/$ITEM -> $APP_INCLUDES_DIR/$ITEM"
        ln -s "$PROJECT_I9F_INCLUDES_DIR/$ITEM" "$APP_INCLUDES_DIR/$ITEM"
    fi
done

# Log the set layout version
LOG_DIR="$BASEDIR/app/log"
LOG_FILE="i9f_layout.log"
LOG_PATH="$LOG_DIR/$LOG_FILE"
CURRENT_TIME=$(date +"%Y-%m-%d %H-%M-%S")
echo "$CURRENT_TIME - Layout version set to 'v$VERSION'" >> $LOG_PATH
echo "Pointed layout revision logged into $LOG_PATH"

cd $PWD
